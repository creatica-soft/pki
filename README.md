## PKI Project

This is a PHP implementation of a server-side certificate management protocol (CMP) documented in rfc4210, 
automatic certificate management environment (ACME), rfc8555, Certificate Enrollment over Secure Transport (EST)
defined in rfc7030, online certificate status protocol (OCSP), rfc6960, Certificate Store Access via HTTP, rfc4387, MS-XCEP (https://winprotocoldoc.blob.core.windows.net/productionwindowsarchives/MS-XCEP/%5bMS-XCEP%5d.pdf) and MS-WSTEP (https://winprotocoldoc.blob.core.windows.net/productionwindowsarchives/MS-WSTEP/%5bMS-WSTEP%5d.pdf).

Fro quick tests and deployment Dockerfile is provided.

Openssl version 3 includes RFC4120-compliant CMP client, which has been tested to work with this server.
Openssl ocsp client has been tested with OCSP server.
Let's Encrypt Certbot has been tested with ACME server.
MS Certificates MMC (certmgr.msc and certlm.msc), certutil.exe and certreq.exe have been tested with MS-XCEP and MS-WSTEP.

The client certificate has a subject with a common name (CN) equaled to sAMAccountName (username) and a role equaled to 'standard'.

ACME uses external account binding to associate ACME client public key with its owner via Active Directory account binding.

Standard role in CMP allows requesting key updates and revocations only to certificates issued to the same user,
i.e. those that have owner field in their subject equaled to CN of a client certificate. 
Standard role is not allowed requesting wildcard certificates.

There exists a 'master' role in CMP, which is free from the above limitations.

In ACME clients are free from the above limitations because ACME performs domain validation (DV) and if successful, then issues
the certificate. 

MS-XCEP is anonymous and MS-WSTEP uses AD LDAP username and password authentication. Default user role is standard. Trusted users can be added to the master role via lib/config.php.

By default MS-XCEP provides three certificate templates (GenericUser, Email and GenericComputer). Additional templates may be added via msxcep/globals.php file.

### Usage example with openssl cmp (see https://www.openssl.org/docs/man3.0/man1/openssl-cmp.html)

1. Download openssl 3.
2. Create openssl.conf configuration file; for example,

```
HOME			= .
openssl_conf = openssl_init
config_diagnostics = 1

[openssl_init]
providers = provider_sect

[provider_sect]
default = default_sect

[default_sect]

[cmp]
server = pki.example.com:443 #test server's IP is 10.161.124.30 to put into your hosts file
path = cmp/
tls_used = 1
implicit_confirm = 0 # set to 0 for explicit certificate confirmations or 1 - for no certconf messages
san_nodefault = 1 #to avoid having CN from the client's certificate subject to be placed in certReq certTemplate SAN extension as DNS
cmd = cr #default command
newkey = test.example.internal.key # rsa private key generated by "openssl genrsa -out test.example.internal.key 2048"
subject = "/CN=test.example.internal" # subject of a certificate to request, renew or revoke
certout = test.example.internal.crt # file where to put the issued or updated certificate
trusted = root.ca.pem # will be provided up on client cert enrollment at https://pki.example.com/cmp/cert_request.html
untrusted = signing.ca.pem # will be provided up on client cert enrollment at https://pki.example.com/cmp/cert_request.html

# Signature-based protection
secret = # disable PBM (shared secret)
cert = username.pem # client certificate obtained via https://pki.example.com/cmp/cert_request.html
key = priv.key # private key for the client certificate obtained by "openssl genrsa -out priv.key 2048"

[ir]
cmd = ir
digest = sha1
mac = hmac-sha1
ref = #SenderKID
secret = pass:LrQonrKWG3gYF0syWenf6omqbBNJXsjvp1SNJwPc9JyTKTSKDGB9GGApmmY0nC_ZUEL_dlEZK7Su7eoiqCJYKAQ
newkey = priv.key
subject = "/CN=username"
certout = username.pem
recipient = "/CN=Signing CA"
reqexts = v3_ext2
cert = #
key = #

[p10cr]
cmd = p10cr
subject = 
san_nodefault =
newkey =

[cr]
cmd = cr

[kur]
# Certificate update
cmd = kur
oldcert = $cmp::certout # test.example.internal.crt
subject = 

[rr]
# Certificate revocation
cmd = rr
oldcert = $cmp::certout # test.example.internal.crt
cacertsout =
certout = 
newkey = 
subject =
san_nodefault = 

[genm]
cmd = genm
cacertsout =
certout = 
newkey = 
subject = 
san_nodefault =

[v3_ext]
# see https://www.openssl.org/docs/man3.0/man5/x509v3_config.html
keyUsage = digitalSignature,keyEncipherment
extendedKeyUsage = serverAuth
subjectAltName = DNS:test.example.internal,DNS:test2.example.internal,IP:10.2.3.4

[v3_ext2]
keyUsage = digitalSignature
```

3. Obtain a client certificate, signing cert and root CA at https://pki.example.com/cmp/cert_request.html. Alternatively, get a shared secret from https://pki.example.com/key_request.html, update openssl.conf [ir] section and get the client cert using

```
openssl cmp -config openssl.conf -section cmp,ir -verbosity 8
```

4. Execute cmp commands; for example, to obtain a new cert, run

```
openssl cmp -config openssl.conf -section cmp,cr -verbosity 8
```

5. To renew the certificate without updating its public key, just run

```
openssl cmp -config openssl.conf -section cmp,kur -verbosity 8
```

6. To update the public key, generate a new private key and then repeat the above command. 
Important to know that the key update request (KUR) is also known as a "certificate update" operation, 
so any extensions presented in the old cert that a user wants to preserve, need to be included in this request 
(such as -sans option or -reqexts section), otherwise, they will be dropped as part of this update. 
The old certificate will still be valid (i.e. it won't be revoked automatically). So this request is pretty much
identical to the new certificate request (CR) because we do not require uniqueness of a subject name.

```
openssl genrsa -out test.example.internal.key 2048
openssl cmp -config openssl.conf -section cmp,kur -verbosity 8
```

7. To revoke the existing cert, run

```
openssl cmp -config openssl.conf -section cmp,rr -verbosity 8
```

8. To request a certificate with Subject Alternative Names (SANs) - only DNS names with suffixes from domains.txt and IPs in the range 10.x.x.x are allowed, run:

```
openssl cmp -config openssl.conf -section cmp,cr -sans test.example.internal,test2.example.internal,10.2.3.4 -verbosity 8
```

9. To request a certificate with v3 extensions, use -reqexts <openssl.conf section> option run:

```
openssl cmp -config openssl.conf -section cmp,cr -reqexts v3_ext -verbosity 8
```

10. To request a certificate using certificate request file (CSR), run:

```
openssl cmp -config openssl.conf -section cmp,cr -csr filename.csr -verbosity 8
```

11. To verify the issued certificate test.example.internal.crt using CRL and/or OCSP, run

```
openssl verify -x509_strict -crl_check_all -crl_download -untrusted signing.ca.pem -trusted root.ca.pem test.example.internal.crt
openssl ocsp -url http://pki.example.com/ocsp/ -issuer signing_ca.pem -cert test.example.internal.crt
```

### Certificate database

Certificates are stored in sqlite3 db. The schema is very simple. It consists of three tables with some indexes:

```
sudo sqlite3 /var/pki/certs.db \
  'create table certs(serial TEXT PRIMARY KEY ASC, status INTEGER, revocationReason INTEGER, revocationDate INTEGER, notBefore INTEGER, notAfter INTEGER, subject TEXT, owner TEXT, role TEXT, cert BLOB, cn TEXT, fingerprint TEXT, sHash TEXT, iAndSHash TEXT, sKIDHash TEXT);' \
  'CREATE INDEX subj_idx on certs(subject); CREATE INDEX status_idx on certs(status); CREATE INDEX from_idx on certs(notBefore);' \
  'CREATE INDEX to_idx on certs(notAfter); CREATE INDEX owner_idx on certs(owner); CREATE INDEX role_idx on certs(role);' \
  'CREATE INDEX cn_idx on certs(cn); CREATE INDEX fingerprint_idx on certs(fingerprint); CREATE INDEX sHash_idx on certs(sHash);' \
  'CREATE INDEX iAndSHash_idx on certs(iAndSHash); CREATE INDEX sKIDHash_idx on certs(sKIDHash);'

sudo sqlite3 /var/pki/certs.db \
  'create table cert_req_ids(serial TEXT PRIMARY KEY ASC, certReqId TEXT, timestamp INTEGER, nonce TEXT, transactionID TEXT);' \
  'CREATE INDEX certReqId_idx on cert_req_ids(certReqId); CREATE INDEX transactionID_idx on cert_req_ids(transactionID);'

//kid is AD username, key is base64url_encoded shared key bytes, used for auth in CMP IR and ACME
sudo sqlite3 /var/pki/certs.db \
  'create table keys(kid TEXT PRIMARY KEY ASC, key TEXT);'
```

cert_req_ids table has unconfirmed cert_req_ids; once confirmed (or denied) in CERTCONF message or unconfirmed within 
$confirm_wait_time_sec, the cert status should be updated in certs table from 2 (on-hold) to either 0 (valid) or revoked (-1) and the record 
in cert_req_ids should be deleted

### ACME database

```
sudo sqlite3 /var/pki/acme.db \
  'create table nonces(nonce TEXT PRIMARY KEY ASC, ip TEXT, expires INTEGER);' \
  'create index ip_idx on nonces(ip);' \
  'create index expires_idx on nonces(expires);'

//uri for an account should look like /acme/accounts/<accountID>
sudo sqlite3 /var/pki/acme.db \
  'create table accounts(id TEXT PRIMARY KEY ASC, status INTEGER, termsOfServiceAgreed INTEGER, jwk_hash TEXT, kid TEXT, jwk BLOB, contacts BLOB, externalAccountBinding BLOB);' \
  'create index jwk_hash_idx on accounts(jwk_hash);' \
  'create index account_status_idx on accounts(status);' \
  'create index account_kid_idx on accounts(kid);'

//uri for an order should look like /acme/accounts/<accountID>/orders/<orderID>
sudo sqlite3 /var/pki/acme.db \
  'PRAGMA foreign_keys = ON;' \
  'create table orders(id TEXT PRIMARY KEY ASC, status INTEGER, expires INTEGER, identifiers BLOB, notBefore INTEGER, notAfter INTEGER, certSerial TEXT, account TEXT, foreign key(account) references accounts(id) ON DELETE CASCADE);' \
  'create index order_status_idx on orders(status);' \
  'create index order_expires_idx on orders(expires);' \
  'create index notBefore_idx on orders(notBefore);' \
  'create index notAfter_idx on orders(notAfter);'

//uri for authorizations should look like /acme/accounts/<accountID>/orders/<orderID>/authorizations/<authorizationID>
sudo sqlite3 /var/pki/acme.db \
  'PRAGMA foreign_keys = ON;' \
  'create table authorizations(id TEXT PRIMARY KEY ASC, identifier BLOB, status INTEGER, expires INTEGER, wildcard INTEGER, "order" TEXT, foreign key("order") references orders(id) ON DELETE CASCADE);' \
  'create index authorization_status_idx on authorizations(status);' \
  'create index authorization_expires_idx on authorizations(expires);'

//uri for challenges should look like /acme/accounts/<accountID>/orders/<orderID>/authorizations/<authorizationID>/challenges/<challengeID>
sudo sqlite3 /var/pki/acme.db \
  'PRAGMA foreign_keys = ON;' \
  'create table challenges(id TEXT PRIMARY KEY ASC, type TEXT, url TEXT, status INTEGER, token TEXT, error TEXT, validated INTEGER, authorization TEXT, foreign key(authorization) references authorizations(id) ON DELETE CASCADE);' \
  'create index type_idx on challenges(type);' \
  'create index challenge_status_idx on challenges(status);' \
  'create index token_idx on challenges(token);' \
  'create index validated_idx on challenges(validated);'

nonces table is used for ACME nonces, ip is the acme client's IP address; once the nonce is used, it's removed from the table
```

There is a plan to upgrade it to postgres cluster to be able to use anycast technology, 
which would not only make PKI servers load-balanced and redundant but also closer to end users.

### Common PHP library

| File name                 | PHP Classes                                      | Notes                                           |
| ------------------------  | ------------------------------------------------ | ----------------------------------------------- |
| lib/algorithm_identifier.php  | DHBMParameter, PBMParameter, AlgorithmIdentifier | https://datatracker.ietf.org/doc/html/rfc5280#section-4.1.2.3 |
| lib/atv.php                   | AttributeTypeAndValue - used by Name class       | https://datatracker.ietf.org/doc/html/rfc4519   |
| lib/base64url.php             | base64url_encode() and base64url_decode()        | https://datatracker.ietf.org/doc/html/rfc4648#section-5 |
| lib/cert_id.php               | CertHash, CertId                                 | Certificate Hash                                | 
| lib/cert_template.php         | CertTemplate                                     | https://datatracker.ietf.org/doc/html/rfc4211#section-5 |
| lib/certificate.php           | TBSCertificate, Certificate                      | https://datatracker.ietf.org/doc/html/rfc5280#section-4.1.1 |
| lib/certification_request.php | CertificationRequestInfo, CertificationRequest   | https://datatracker.ietf.org/doc/html/rfc2986 |
| lib/extension.php             | Extensions, Extension                            | https://datatracker.ietf.org/doc/html/rfc5280#section-4.2 |
| lib/general_name.php          | RDN, Name, GeneralName                           | https://datatracker.ietf.org/doc/html/rfc4210#section-5.1.1 |
| lib/signed_data.php           | ContentInfo, SignedData, SignerInfo              | https://datatracker.ietf.org/doc/html/rfc5652 (PKCS #7) |
| lib/subject_pubkey_info.php   | RSAPublicKey, DSAPublicKey, DHPublicKey, ECPublicKey, SubjectPublicKeyInfo | https://datatracker.ietf.org/doc/html/rfc5280#section-4.1.2.7 |
| lib/validity.php              | Validity                                         | https://datatracker.ietf.org/doc/html/rfc5280#section-4.1.2.5 |

### PHP Classes for CMP

| File name                 | PHP Classes                                      | Notes                                           |
| ------------------------  | ------------------------------------------------ | ----------------------------------------------- |
| cmp/cert_confirm.php          | CertStatus, CertConfirmContent                   | https://datatracker.ietf.org/doc/html/rfc4210#section-5.3.18 |
| cmp/cert_rep_msg.php          | CertRepMessage                                   | https://datatracker.ietf.org/doc/html/rfc4210#section-5.3.4 |
| cmp/cert_req.php              | CertReq                                          | https://datatracker.ietf.org/doc/html/rfc4211#section-5 |
| cmp/cert_req_msg.php          | CertReqMessages, CertReqMessage                  | https://datatracker.ietf.org/doc/html/rfc4211#section-3 |
| cmp/cert_response.php         | CertResponse                                     | https://datatracker.ietf.org/doc/html/rfc4210#section-5.3.4 |
| cmp/certified_key_pair.php    | CertifiedKeyPair                                 | https://datatracker.ietf.org/doc/html/rfc4210#section-5.3.4 |
| cmp/controls.php              | Controls                                         | https://datatracker.ietf.org/doc/html/rfc4211#section-6 |
| cmp/error_msg.php             | ErrorMsgContent                                  | https://datatracker.ietf.org/doc/html/rfc4210#section-5.3.21 |
| cmp/extra_certs.php           | ExtraCerts                                       | https://datatracker.ietf.org/doc/html/rfc4210#section-5.1 |
| cmp/genm.php                  | InfoTypeAndValue, GenMsgContent, GeneralInfo     | https://datatracker.ietf.org/doc/html/rfc4210#section-5.3.19 |
| cmp/pki_body.php              | PKIBody                                          | https://datatracker.ietf.org/doc/html/rfc4210#section-5.1.2 |
| cmp/pki_header.php            | PKIFreeText, PKIHeader                           | https://datatracker.ietf.org/doc/html/rfc4210#section-5.1.1 |
| cmp/pki_message.php           | PKIMessage                                       | https://datatracker.ietf.org/doc/html/rfc4210#section-5.1 |
| cmp/pki_protection.php        | PKIProtection                                    | https://datatracker.ietf.org/doc/html/rfc4210#section-5.1 |
| cmp/pki_status_info.php       | PKIStatusInfo                                    | https://datatracker.ietf.org/doc/html/rfc4210#section-5.2.3 |
| cmp/popo_signing_key.php      | POPOPrivKey, PKMACValue, POPOSKInput, POPOSigningKey | https://datatracker.ietf.org/doc/html/rfc4210#section-5.2.8 |
| cmp/rev_rep.php               | RevRepContent, CRL, RevokedCerts, RevokedCert, TBSCRL | https://datatracker.ietf.org/doc/html/rfc4210#section-5.3.10 |
| cmp/rev_req.php               | RevReq, RevReqContent                            | https://datatracker.ietf.org/doc/html/rfc4210#section-5.3.9 |

### PHP Classes for ACME

| File name                 | PHP Classes                                      | Notes                                           |
| ------------------------  | ------------------------------------------------ | ----------------------------------------------- |
| acme/account.php               | Account class                                    | https://datatracker.ietf.org/doc/html/rfc8555#section-7.1.2 |
| acme/acme_request.php          | ACME request class                               | https://datatracker.ietf.org/doc/html/rfc8555#section-6.1 |
| acme/authorization.php         | Authorization class                              | https://datatracker.ietf.org/doc/html/rfc8555#section-7.1.4 |
| acme/challenge.php             | Challenge class                                  | https://datatracker.ietf.org/doc/html/rfc8555#section-7.1.5 |
| acme/order.php                 | Order class                                      | https://datatracker.ietf.org/doc/html/rfc8555#section-7.1.3 |
https://datatracker.ietf.org/doc/html/rfc5280#section-4.1.2.7 |

### PHP Classes for EST

| File name                 | PHP Classes                                      | Notes                                           |
| ------------------------  | ------------------------------------------------ | ----------------------------------------------- |


### Other files

server.php is the CMP, ACME, EST, OCSP, MS-XCEP or MS-WSTEP server, which answers the CMP, ACME, EST, OCSP, MS-XCEP or MS-WSTEP requests.

lib/asn1_types.php is ITU-T X680/X690 ASN.1 type constants

lib/asn1decode.php - ITU-T X680/X690 ASN.1 decoder, which will get the binary data (DER) and return an array, which is later mapped to CMP class properties.

lib/asn1encode.php - ITU-T X680/X690 ASN.1 encoder, which will take a class, a constructed bit, a type and a value and returns a DER string.

lib/help_functions.php - a bunch of useful functions that are consumed by any file.

lib/sql.php - SQL functions related to certs.db table operations such as select, insert, update and delete
lib/acme_sql.php - SQL functions related to acme.db table operations such as select, insert, update and delete
lib/cmp_sql.php - SQL functions related to certs.db table operations such as select, insert, update and delete

lib/config.php - this is where all common configuration settings are.
globals.php - this is where protocol-specific configuration settings are.

lib/asn1parse.php - very similar to openssl asn1parse, it takes a file in DER or PEM encoding as a first argument and 'pem' as a second if needed.

### Automatic Certificate Management Environment (ACME), RFC 8555

This is Let's Encrypt server. There are many ACME clients. A client must support external account binding. Many do not.
Recommended ACME client is Certbot from Let's Encrypt.

### Enrollment over Secure Transport

This is a simplified version of both CMP and CMC (rfc5273) protocols. Three well-known URIs are supported: cacerts, simpleenroll and simplereenroll. 
Certificate revocation, which requires full CMC, is not supported since it is optional in rfc7030. AD username and password as well as SSL client certificate authentication with standard and master roles are supported. Same as in CMP, no domain validation. EST clients do exist but are not required. Certificates can simply be requested using curl and openssl req, base64 and pkcs7 commands. Both openssl versions (1 and 3) work with EST server.


### Certificate Enrollment Protocol MS-XCEP

This protocol is used by MS Certificates MMC (certmgr.msc and certlm.msc) to get certificate templates and certificate enrollment url where to submit certification requests (CSR or CMC). This is XML-based protocol, more precisely SOAP 1.2.

### WS-Trust X.509v3 Token Enrollment Extensions MS-WSTEP

This protocol is used by the same Microsoft tools as MS-XCEP to actually request and renew certificates. In theory it should support certificate revocation because it uses full CMC but in practice there is no GUI functions in Certificates MMC to do this; hence, the server side also does not implement certificate revocation.

### Online Certificate Status Protocol (OCSP), RFCs 6960 and 5019

openssl provides ocsp client, which can be used to verify that OCSP server works fine. Also, openssl verify command may be used.

### Certificate Store Access via HTTP, RFC 4387

Well-known URLs are provided for certificates and CRLs:

```
https://pki.example.com/certificates/search.cgi?attirbute=value
https://pki.example.com/crls/search.cgi?attirbute=value
```

where all x.509 attributes are supported: certHash, uri, iHash, iAndSHash, name, cn, sHash, sKIDHash.